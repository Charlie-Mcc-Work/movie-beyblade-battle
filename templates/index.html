<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Beyblade Battle</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            font-family: sans-serif;
        }
        #game-canvas {
            border: 2px solid #444;
            width: 100vw;
            height: 100vh;
            object-fit: contain;
        }
        #status {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #f55;
            padding: 5px 15px;
            background: rgba(0,0,0,0.7);
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        #status.connected { color: #5f5; }
    </style>
</head>
<body>
    <img id="game-canvas" alt="Game">
    <div id="status">Loading...</div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const canvas = document.getElementById('game-canvas');
        const status = document.getElementById('status');
        const GAME_WIDTH = {{ width }};
        const GAME_HEIGHT = {{ height }};

        status.textContent = 'Connecting...';

        const socket = io();

        socket.on('connect', function() {
            console.log('Connected to server');
            status.textContent = 'Connected';
            status.className = 'connected';
        });

        socket.on('disconnect', function() {
            console.log('Disconnected');
            status.textContent = 'Disconnected';
            status.className = '';
        });

        socket.on('connect_error', function(err) {
            console.log('Connection error:', err);
            status.textContent = 'Connection error: ' + err.message;
        });

        socket.on('frame', function(data) {
            canvas.src = 'data:image/jpeg;base64,' + data.data;
        });

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();

            // Account for object-fit: contain - the image maintains aspect ratio
            // so we need to calculate where the actual image is within the element
            const elementAspect = rect.width / rect.height;
            const imageAspect = GAME_WIDTH / GAME_HEIGHT;

            let imageWidth, imageHeight, offsetX, offsetY;

            if (elementAspect > imageAspect) {
                // Element is wider than image - letterboxing on sides
                imageHeight = rect.height;
                imageWidth = rect.height * imageAspect;
                offsetX = (rect.width - imageWidth) / 2;
                offsetY = 0;
            } else {
                // Element is taller than image - letterboxing on top/bottom
                imageWidth = rect.width;
                imageHeight = rect.width / imageAspect;
                offsetX = 0;
                offsetY = (rect.height - imageHeight) / 2;
            }

            let clientX, clientY;
            if (e.touches && e.touches[0]) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.changedTouches && e.changedTouches[0]) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // Convert to image coordinates
            const relX = clientX - rect.left - offsetX;
            const relY = clientY - rect.top - offsetY;

            return {
                x: Math.round((relX / imageWidth) * GAME_WIDTH),
                y: Math.round((relY / imageHeight) * GAME_HEIGHT)
            };
        }

        canvas.addEventListener('mousedown', function(e) {
            e.preventDefault();
            const pos = getPos(e);
            socket.emit('mouse', {type: 'mousedown', button: e.button + 1, x: pos.x, y: pos.y});
        });

        canvas.addEventListener('mouseup', function(e) {
            e.preventDefault();
            const pos = getPos(e);
            socket.emit('mouse', {type: 'mouseup', button: e.button + 1, x: pos.x, y: pos.y});
        });

        canvas.addEventListener('mousemove', function(e) {
            const pos = getPos(e);
            socket.emit('mouse', {type: 'mousemove', x: pos.x, y: pos.y});
        });

        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            const pos = getPos(e);
            socket.emit('mouse', {type: 'mousedown', button: 1, x: pos.x, y: pos.y});
        }, {passive: false});

        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            const pos = getPos(e);
            socket.emit('mouse', {type: 'mouseup', button: 1, x: pos.x, y: pos.y});
        }, {passive: false});

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            const pos = getPos(e);
            socket.emit('mouse', {type: 'mousemove', x: pos.x, y: pos.y});
        }, {passive: false});

        canvas.addEventListener('wheel', function(e) {
            e.preventDefault();
            socket.emit('wheel', {deltaX: e.deltaX, deltaY: e.deltaY});
        }, {passive: false});

        canvas.addEventListener('contextmenu', function(e) { e.preventDefault(); });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5' || e.key === 'F12' || (e.ctrlKey && e.key === 'r')) return;
            e.preventDefault();
            socket.emit('key', {
                type: 'keydown',
                jsKey: e.key,
                unicode: e.key.length === 1 ? e.key : '',
                ctrl: e.ctrlKey,
                shift: e.shiftKey,
                alt: e.altKey
            });
        });

        document.addEventListener('keyup', function(e) {
            socket.emit('key', {
                type: 'keyup',
                jsKey: e.key,
                ctrl: e.ctrlKey,
                shift: e.shiftKey,
                alt: e.altKey
            });
        });

        document.addEventListener('paste', function(e) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            if (text) socket.emit('paste', {text: text});
        });
    </script>
</body>
</html>
